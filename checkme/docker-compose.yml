# =============================================================================
# AFASA 2.0 - Multi-Tenant AI Agricultural Monitoring
# Docker Compose Topology (Phase-aligned)
# =============================================================================

networks:
  afasa_net:
    driver: bridge

volumes:
  pgdata:
  minio_data:
  keycloak_data:
  prometheus_data:
  grafana_data:


services:
  # ===========================================================================
  # EDGE ROUTING (Traefik)
  # ===========================================================================
  traefik:
    image: traefik:latest
    environment:
      - DOCKER_API_VERSION=1.45 # Forcing newer API version
    command:
      - "--api.dashboard=true"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=afasa2_afasa_net"
      - "--entrypoints.web.address=:80"
      - "--metrics.prometheus=true"
      - "--metrics.prometheus.addEntryPointsLabels=true"
      - "--metrics.prometheus.addServicesLabels=true"
    ports:
      - "80:80"
      - "8081:8080" # Traefik Dashboard
      - "8082:8082" # Metrics
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks: [ afasa_net ]
    restart: unless-stopped

  # ===========================================================================
  # DATABASE (Postgres with RLS)
  # ===========================================================================
  postgres:
    image: postgres:16
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-afasa}
      POSTGRES_USER: ${POSTGRES_USER:-afasa}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-afasa_pass}
      TZ: UTC
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./infra/postgres/init:/docker-entrypoint-initdb.d:ro
    networks: [ afasa_net ]
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-afasa}" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # CACHE & RATE LIMITING (Redis)
  # ===========================================================================
  redis:
    image: redis:7
    command: [ "redis-server", "--appendonly", "yes" ]
    ports:
      - "6379:6379"
    networks: [ afasa_net ]
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # EVENT BUS (NATS with JetStream)
  # ===========================================================================
  nats:
    image: nats:2.10-alpine
    command: [ "-js", "-m", "8222" ]
    ports:
      - "4222:4222"
      - "8222:8222"
    networks: [ afasa_net ]
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "nc -z localhost 4222 || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # OBJECT STORAGE (MinIO)
  # ===========================================================================
  minio:
    image: minio/minio:latest
    command: [ "server", "/data", "--console-address", ":9001" ]
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio_pass}
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    networks: [ afasa_net ]
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # IDENTITY (Keycloak)
  # ===========================================================================
  keycloak:
    image: quay.io/keycloak/keycloak:25.0
    command: [ "start-dev", "--import-realm" ]
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/${POSTGRES_DB:-afasa}
      KC_DB_USERNAME: ${POSTGRES_USER:-afasa}
      KC_DB_PASSWORD: ${POSTGRES_PASSWORD:-afasa_pass}
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      KC_HTTP_ENABLED: "true"
      KC_PROXY: edge
      KC_HEALTH_ENABLED: "true"
      KC_METRICS_ENABLED: "true"
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "8080:8080"
    networks: [ afasa_net ]
    volumes:
      - keycloak_data:/opt/keycloak/data
      - ./afasa-realm.json:/opt/keycloak/data/import/afasa-realm.json:ro
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/health/ready" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  # ===========================================================================
  # RTSP â†’ HLS TRANSCODING (MediaMTX)
  # ===========================================================================
  mediamtx:
    image: bluenviron/mediamtx:latest
    volumes:
      - ./infra/mediamtx/mediamtx.yml:/mediamtx.yml:ro
    ports:
      - "8554:8554" # RTSP
      - "8888:8888" # HLS HTTP
    networks: [ afasa_net ]
    restart: unless-stopped

  # ===========================================================================
  # AFASA SERVICES - Phase 2: Vision Core
  # ===========================================================================

  afasa-media:
    build:
      context: .
      dockerfile: services/media/Dockerfile
    environment:
      DATABASE_URL: ${DATABASE_URL}
      NATS_URL: ${NATS_URL}
      MINIO_ENDPOINT: ${MINIO_ENDPOINT}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_BUCKET: ${MINIO_BUCKET}
      OIDC_ISSUER_URL: ${OIDC_ISSUER_URL}
      OIDC_AUDIENCE: ${OIDC_AUDIENCE}
      AFASA_MASTER_KEY_BASE64: ${AFASA_MASTER_KEY_BASE64}
      MEDIAMTX_API_BASE: http://mediamtx:8888
      TZ: UTC
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
      minio:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    networks: [ afasa_net ]
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.media.rule=PathPrefix(`/api/media`)"
      - "traefik.http.routers.media.entrypoints=web"
      - "traefik.http.services.media.loadbalancer.server.port=8000"

  afasa-vision-yolo:
    build:
      context: .
      dockerfile: services/vision_yolo/Dockerfile
    environment:
      DATABASE_URL: ${DATABASE_URL}
      NATS_URL: ${NATS_URL}
      REDIS_URL: ${REDIS_URL}
      MINIO_ENDPOINT: ${MINIO_ENDPOINT}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_BUCKET: ${MINIO_BUCKET}
      OIDC_ISSUER_URL: ${OIDC_ISSUER_URL}
      OIDC_AUDIENCE: ${OIDC_AUDIENCE}
      TZ: UTC
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks: [ afasa_net ]
    restart: unless-stopped
    # Uncomment for GPU support:
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - capabilities: [gpu]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.yolo.rule=PathPrefix(`/api/vision/yolo`)"
      - "traefik.http.routers.yolo.entrypoints=web"
      - "traefik.http.services.yolo.loadbalancer.server.port=8000"

  afasa-vision-reasoner:
    build:
      context: .
      dockerfile: services/vision_reasoner/Dockerfile
    environment:
      DATABASE_URL: ${DATABASE_URL}
      NATS_URL: ${NATS_URL}
      MINIO_ENDPOINT: ${MINIO_ENDPOINT}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_BUCKET: ${MINIO_BUCKET}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      AFASA_MASTER_KEY_BASE64: ${AFASA_MASTER_KEY_BASE64}
      OIDC_ISSUER_URL: ${OIDC_ISSUER_URL}
      OIDC_AUDIENCE: ${OIDC_AUDIENCE}
      TZ: UTC
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks: [ afasa_net ]
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.reasoner.rule=PathPrefix(`/api/vision/reasoner`)"
      - "traefik.http.routers.reasoner.entrypoints=web"
      - "traefik.http.services.reasoner.loadbalancer.server.port=8000"

  # ===========================================================================
  # AFASA SERVICES - Phase 3: Operations & Governance
  # ===========================================================================

  afasa-ops:
    build:
      context: .
      dockerfile: services/ops/Dockerfile
    environment:
      DATABASE_URL: ${DATABASE_URL}
      NATS_URL: ${NATS_URL}
      REDIS_URL: ${REDIS_URL}
      MINIO_ENDPOINT: ${MINIO_ENDPOINT}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_BUCKET: ${MINIO_BUCKET}
      AFASA_MASTER_KEY_BASE64: ${AFASA_MASTER_KEY_BASE64}
      OIDC_ISSUER_URL: ${OIDC_ISSUER_URL}
      OIDC_AUDIENCE: ${OIDC_AUDIENCE}
      TB_BASE_URL: ${TB_BASE_URL}
      TB_JWT: ${TB_JWT}
      TZ: UTC
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks: [ afasa_net ]
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ops.rule=PathPrefix(`/api/ops`) || PathPrefix(`/api/tasks`) || PathPrefix(`/api/rules`) || PathPrefix(`/api/settings`) || PathPrefix(`/api/audit`)"
      - "traefik.http.routers.ops.entrypoints=web"
      - "traefik.http.services.ops.loadbalancer.server.port=8000"

  # ===========================================================================
  # AFASA SERVICES - Phase 4: Integration
  # ===========================================================================

  afasa-telegram:
    build:
      context: .
      dockerfile: services/telegram/Dockerfile
    environment:
      DATABASE_URL: ${DATABASE_URL}
      NATS_URL: ${NATS_URL}
      REDIS_URL: ${REDIS_URL}
      AFASA_MASTER_KEY_BASE64: ${AFASA_MASTER_KEY_BASE64}
      OIDC_ISSUER_URL: ${OIDC_ISSUER_URL}
      OIDC_AUDIENCE: ${OIDC_AUDIENCE}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      TELEGRAM_WEBHOOK_SECRET: ${TELEGRAM_WEBHOOK_SECRET}
      PUBLIC_BASE_URL: ${PUBLIC_BASE_URL}
      TZ: UTC
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks: [ afasa_net ]
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.tg.rule=PathPrefix(`/api/telegram`)"
      - "traefik.http.routers.tg.entrypoints=web"
      - "traefik.http.services.tg.loadbalancer.server.port=8000"

  afasa-report:
    build:
      context: .
      dockerfile: services/report/Dockerfile
    environment:
      DATABASE_URL: ${DATABASE_URL}
      NATS_URL: ${NATS_URL}
      MINIO_ENDPOINT: ${MINIO_ENDPOINT}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_BUCKET: ${MINIO_BUCKET}
      OIDC_ISSUER_URL: ${OIDC_ISSUER_URL}
      OIDC_AUDIENCE: ${OIDC_AUDIENCE}
      TZ: UTC
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks: [ afasa_net ]
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.report.rule=PathPrefix(`/api/report`) || PathPrefix(`/api/assets`)"
      - "traefik.http.routers.report.entrypoints=web"
      - "traefik.http.services.report.loadbalancer.server.port=8000"

  afasa-tb-adapter:
    build:
      context: .
      dockerfile: services/tb_adapter/Dockerfile
    environment:
      DATABASE_URL: ${DATABASE_URL}
      NATS_URL: ${NATS_URL}
      AFASA_MASTER_KEY_BASE64: ${AFASA_MASTER_KEY_BASE64}
      OIDC_ISSUER_URL: ${OIDC_ISSUER_URL}
      OIDC_AUDIENCE: ${OIDC_AUDIENCE}
      TB_BASE_URL: ${TB_BASE_URL}
      TB_JWT: ${TB_JWT}
      UBIBOT_BASE_URL: ${UBIBOT_BASE_URL}
      TZ: UTC
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
    networks: [ afasa_net ]
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.tb.rule=PathPrefix(`/api/tb`) || PathPrefix(`/api/devices`) || PathPrefix(`/api/integrations`) || PathPrefix(`/api/discovery`)"
      - "traefik.http.routers.tb.entrypoints=web"
      - "traefik.http.services.tb.loadbalancer.server.port=8000"

  # ===========================================================================
  # AFASA SERVICES - Phase 1: Operational Hardening
  # ===========================================================================

  afasa-retention-cleaner:
    build:
      context: .
      dockerfile: services/retention_cleaner/Dockerfile
    environment:
      DATABASE_URL: ${DATABASE_URL}
      MINIO_ENDPOINT: ${MINIO_ENDPOINT}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_BUCKET: ${MINIO_BUCKET}
      TZ: UTC
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks: [ afasa_net ]
    restart: unless-stopped

  # ===========================================================================
  # AFASA SERVICES - Phase 5: Frontend
  # ===========================================================================

  afasa-portal:
    build:
      context: .
      dockerfile: services/portal/Dockerfile
      args:
        VITE_PUBLIC_BASE_URL: ${PUBLIC_BASE_URL}
        VITE_OIDC_ISSUER_URL: ${OIDC_ISSUER_URL}
        VITE_OIDC_CLIENT_ID: ${OIDC_CLIENT_ID}
    environment:
      VITE_PUBLIC_BASE_URL: ${PUBLIC_BASE_URL}
      VITE_OIDC_ISSUER_URL: ${OIDC_ISSUER_URL}
      VITE_OIDC_CLIENT_ID: ${OIDC_CLIENT_ID}
      VITE_OIDC_AUDIENCE: ${OIDC_AUDIENCE}
    depends_on:
      keycloak:
        condition: service_healthy
    networks: [ afasa_net ]
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portal.rule=PathPrefix(`/portal`) || PathPrefix(`/`)"
      - "traefik.http.routers.portal.entrypoints=web"
      - "traefik.http.routers.portal.priority=1"
      - "traefik.http.services.portal.loadbalancer.server.port=5173"

  # ===========================================================================
  # OBSERVABILITY - Phase 1: Required
  # ===========================================================================

  prometheus:
    image: prom/prometheus:latest
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    ports:
      - "9090:9090"
    volumes:
      - prometheus_data:/prometheus
      - ./deploy/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    networks: [ afasa_net ]
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
      GF_USERS_ALLOW_SIGN_UP: "false"
    ports:
      - "3001:3000"
    volumes:
      - grafana_data:/var/lib/grafana
    networks: [ afasa_net ]
    restart: unless-stopped
    depends_on:
      - prometheus
